{% extends "base.html" %} {% block title %}Detectar em V√≠deo - Sistema de
Detec√ß√£o de Ve√≠culos de Emerg√™ncia{% endblock %} {% block content %}
	<div class="container">
	  {% if request.args.get('message') %}
	  <div class="alert alert-success">
	    {{ request.args.get('message') | url_decode }}
	  </div>
	  {% endif %}
  <h1>Detectar Ve√≠culos em V√≠deo</h1>

  {% if error %}
  <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üìπ Upload de V√≠deo</h3>
        </div>
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data" id="uploadForm" action="{{ url_for('detect_video') }}">
            <div class="form-group">
              <label for="file"><strong>Selecione um v√≠deo:</strong></label>
              <input
                type="file"
                id="file"
                name="file"
                accept="video/*"
                class="form-control-file"
                required
              />
              <small class="form-text text-muted">
                Formatos aceitos: MP4, AVI, MOV, MKV (m√°ximo 100MB)
              </small>
            </div>

            <div class="form-group">
              <label for="source_id"
                ><strong>ID da Fonte (opcional):</strong></label
              >
              <input
                type="text"
                id="source_id"
                name="source_id"
                class="form-control"
                placeholder="camera_01"
                value="uploaded_video"
              />
              <small class="form-text text-muted">
                Identificador √∫nico para a fonte do v√≠deo
              </small>
            </div>

            <button
              type="submit" id="submitBtn"
              class="btn btn-primary btn-lg btn-block"
            >
              üöÄ Processar V√≠deo
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <div class="card mt-4">
    <div class="card-header">
      <h3 class="card-title">üìã V√≠deos Processados</h3>
    </div>
    <div class="card-body">
      <p class="text-muted">
        Acompanhe todos os seus v√≠deos processados em uma √∫nica p√°gina.
      </p>
      <a href="{{ url_for('video_jobs_list') }}" class="btn btn-outline">
        üìã Ver Todos os V√≠deos Processados
      </a>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline">
        üìä Ver Relat√≥rios Completos
      </a>
    </div>
  </div>
</div>

<script>
	  const uploadForm = document.getElementById("uploadForm");
	  const submitBtn = document.getElementById("submitBtn");
	  const statusArea = document.createElement('div');
	  statusArea.id = 'statusArea';
	  statusArea.style.marginTop = '20px';
	  document.querySelector('.card-body').appendChild(statusArea);
	
	  uploadForm.addEventListener("submit", function (e) {
	    e.preventDefault();
	    
	    submitBtn.disabled = true;
	    submitBtn.innerHTML = "‚è≥ Processando V√≠deo...";
	    
	    const formData = new FormData(uploadForm);
	    
	    // 1. Exibir "Upload em Andamento..." imediatamente
	    statusArea.innerHTML = `
	        <div class="alert alert-info" id="uploadStatus">
	            <h5>‚è≥ Upload em Andamento...</h5>
	            <p>Por favor, aguarde. O upload e o processamento do v√≠deo podem levar alguns minutos.</p>
	            <div class="progress mb-2">
	                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
	            </div>
	        </div>
	    `;
	    
	    // 2. Iniciar o upload
	    const uploadPromise = fetch(uploadForm.action, {
	        method: 'POST',
	        body: formData
	    })
	    .then(response => {
	        if (response.redirected) {
	            window.location.href = response.url;
	            // Retorna um objeto que n√£o ser√° processado pelos .then() seguintes
	            return { redirected: true }; 
	        }
	        return response.json().then(data => {
	            if (!response.ok) {
	                throw new Error(data.detail || data.error || 'Erro desconhecido no upload');
	            }
	            return data;
	        });
	    });
	    
	    // 3. Criar um delay de 50 segundos
	    const delayPromise = new Promise(resolve => {
	        setTimeout(() => {
	            resolve();
	        }, 50000); // 50 segundos
	    });
	    
	    // 4. Esperar o upload E o delay terminarem
	    Promise.all([uploadPromise, delayPromise])
	    .then(([data, _]) => {
	        // Se houve redirecionamento, a execu√ß√£o j√° foi interrompida acima
	        if (data && data.redirected) return; 

	        if (data && data.job_id) {
	            const jobId = data.job_id;
	            
	            // 5. Exibir "V√≠deo Enviado!"
	            statusArea.innerHTML = `
	                <div class="alert alert-success">
	                    <h5>‚úÖ V√≠deo Enviado!</h5>
	                    <p>O processamento foi iniciado em background (ID do Job: <strong>${jobId}</strong>).</p>
	                    <p>Acompanhe o status na <a href="{{ url_for('video_jobs_list') }}">lista de jobs</a>.</p>
	                </div>
	            `;
	            submitBtn.disabled = false;
	            submitBtn.innerHTML = "üöÄ Processar Outro V√≠deo";
	            
	        } else {
	            throw new Error('Resposta da API inv√°lida ou job_id ausente.');
	        }
	    })
	    .catch(error => {
	        // O erro pode vir do upload ou de uma falha no processamento do JSON
	        console.error('Erro no upload:', error);
	        statusArea.innerHTML = `
	            <div class="alert alert-danger">
	                <h5>‚ùå Erro no Upload</h5>
	                <p>${error.message}</p>
	            </div>
	        `;
	        submitBtn.disabled = false;
	        submitBtn.innerHTML = "üöÄ Processar V√≠deo";
	    });
	  });
</script>
{% endblock %}
